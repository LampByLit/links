<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lynx - Link Preview Generator</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState } = React;

        function UploadForm() {
            const [image, setImage] = useState(null);
            const [link, setLink] = useState('');
            const [title, setTitle] = useState('');
            const [description, setDescription] = useState('');
            const [previewUrl, setPreviewUrl] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [imageAnalysis, setImageAnalysis] = useState(null);
            const [selectedFormat, setSelectedFormat] = useState(null);
            const [cropData, setCropData] = useState(null);

            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    setImage(file);
                    
                    // Analyze the image
                    const img = new Image();
                    img.onload = () => {
                        const analysis = analyzeImage(img.width, img.height);
                        setImageAnalysis(analysis);
                        
                        // If perfect match, auto-select format
                        if (analysis.perfectMatch) {
                            setSelectedFormat(analysis.perfectMatch.type);
                        }
                    };
                    img.src = URL.createObjectURL(file);
                }
            };

            // Image analysis function
            const analyzeImage = (width, height) => {
                const aspectRatio = width / height;
                const tolerance = 0.05;
                
                const formats = [
                    { type: 'portrait', aspectRatio: 2/3, width: 400, height: 600, description: 'Portrait (Summary Card)' },
                    { type: 'landscape', aspectRatio: 2, width: 1200, height: 600, description: 'Landscape (Summary Card with Large Image)' },
                    { type: 'square', aspectRatio: 1, width: 400, height: 400, description: 'Square (App Card)' }
                ];
                
                // Check for perfect match
                for (const format of formats) {
                    const ratioDifference = Math.abs(aspectRatio - format.aspectRatio);
                    const formatTolerance = format.aspectRatio * tolerance;
                    
                    if (ratioDifference <= formatTolerance) {
                        return {
                            originalWidth: width,
                            originalHeight: height,
                            originalAspectRatio: aspectRatio,
                            recommendedFormats: [format],
                            needsCropping: false,
                            perfectMatch: format
                        };
                    }
                }
                
                // No perfect match - recommend all formats
                return {
                    originalWidth: width,
                    originalHeight: height,
                    originalAspectRatio: aspectRatio,
                    recommendedFormats: formats,
                    needsCropping: true
                };
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                
                if (!image || !link) {
                    alert('Please upload an image and provide a link');
                    return;
                }

                if (!selectedFormat) {
                    alert('Please select a format for your image');
                    return;
                }

                setIsLoading(true);
                const formData = new FormData();
                formData.append('image', image);
                formData.append('link', link);
                formData.append('title', title);
                formData.append('description', description);
                formData.append('imageFormat', selectedFormat);
                
                if (cropData) {
                    formData.append('cropData', JSON.stringify(cropData));
                }

                try {
                    const response = await fetch('/api/upload', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (result.success) {
                        setPreviewUrl(result.previewUrl);
                        // Reset form
                        setImage(null);
                        setLink('');
                        setTitle('');
                        setDescription('');
                        document.querySelector('input[type="file"]').value = '';
                    } else {
                        alert(`Error: ${result.error}`);
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                    alert('Failed to upload. Please try again.');
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <div className="min-h-screen bg-gray-50 flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
                    <div className="max-w-md w-full space-y-8">
                        <div>
                            <h2 className="mt-6 text-center text-3xl font-extrabold text-gray-900">
                                Create Your Link Preview
                            </h2>
                            <p className="mt-2 text-center text-sm text-gray-600">
                                Upload an image and add your link to generate a Twitter Card
                            </p>
                        </div>
                        <form className="mt-8 space-y-6" onSubmit={handleSubmit}>
                            <div className="space-y-4">
                                {/* Image Upload */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">
                                        Upload Image
                                    </label>
                                    <input
                                        type="file"
                                        accept="image/*"
                                        onChange={handleImageUpload}
                                        className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                    />
                                </div>

                                {/* Link Input */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">
                                        Destination Link
                                    </label>
                                    <input
                                        type="url"
                                        value={link}
                                        onChange={(e) => setLink(e.target.value)}
                                        placeholder="https://example.com"
                                        className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                        required
                                    />
                                </div>

                                {/* Title Input */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">
                                        Title (Optional)
                                    </label>
                                    <input
                                        type="text"
                                        value={title}
                                        onChange={(e) => setTitle(e.target.value)}
                                        placeholder="Your card title"
                                        className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                    />
                                </div>

                                {/* Description Input */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">
                                        Description (Optional)
                                    </label>
                                    <textarea
                                        value={description}
                                        onChange={(e) => setDescription(e.target.value)}
                                        placeholder="Your card description"
                                        rows={3}
                                        className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                    />
                                </div>
                            </div>

                            {/* Format Selection */}
                            {imageAnalysis && (
                                <div className="mt-6">
                                    <h3 className="text-lg font-semibold text-gray-900 mb-4">
                                        Choose Your Format
                                    </h3>
                                    
                                    {imageAnalysis.perfectMatch ? (
                                        <div className="bg-green-50 border border-green-200 rounded-md p-4">
                                            <div className="flex items-center">
                                                <div className="flex-shrink-0">
                                                    <svg className="h-5 w-5 text-green-400" viewBox="0 0 20 20" fill="currentColor">
                                                        <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
                                                    </svg>
                                                </div>
                                                <div className="ml-3">
                                                    <p className="text-sm font-medium text-green-800">
                                                        Perfect match found! Your image is ideal for {imageAnalysis.perfectMatch.description}
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                            {imageAnalysis.recommendedFormats.map((format) => (
                                                <div key={format.type} className="border border-gray-200 rounded-md p-4">
                                                    <div className="text-center">
                                                        <div className="text-sm font-medium text-gray-900 mb-2">
                                                            {format.description}
                                                        </div>
                                                        <div className="text-xs text-gray-500 mb-3">
                                                            {format.width} × {format.height}px
                                                        </div>
                                                        <button
                                                            type="button"
                                                            onClick={() => setSelectedFormat(format.type)}
                                                            className={`w-full px-3 py-2 text-sm font-medium rounded-md ${
                                                                selectedFormat === format.type
                                                                    ? 'bg-blue-600 text-white'
                                                                    : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                                            }`}
                                                        >
                                                            {selectedFormat === format.type ? 'Selected' : 'Choose This Format'}
                                                        </button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            )}

                            <div>
                                <button
                                    type="submit"
                                    disabled={isLoading}
                                    className="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    {isLoading ? 'Creating Card...' : 'Generate Link Preview'}
                                </button>
                            </div>
                        </form>
                        
                        {/* Preview Section */}
                        {previewUrl && (
                            <div className="mt-8 p-6 bg-white rounded-lg shadow-md border border-gray-200">
                                <h3 className="text-lg font-semibold text-gray-900 mb-4">Your Card is Ready!</h3>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Share this URL:
                                        </label>
                                        <div className="flex">
                                            <input
                                                type="text"
                                                value={previewUrl}
                                                readOnly
                                                className="flex-1 px-3 py-2 border border-gray-300 rounded-l-md bg-gray-50 text-sm"
                                            />
                                            <button
                                                onClick={() => {
                                                    navigator.clipboard.writeText(previewUrl);
                                                    alert('URL copied to clipboard!');
                                                }}
                                                className="px-4 py-2 bg-blue-600 text-white rounded-r-md hover:bg-blue-700 text-sm"
                                            >
                                                Copy
                                            </button>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Preview:
                                        </label>
                                        <div className="border border-gray-300 rounded-md p-4 bg-gray-50">
                                            <p className="text-sm text-gray-600 mb-2">
                                                When you share this URL on Twitter, it will show as a card with your image and link.
                                            </p>
                                            <a
                                                href={previewUrl}
                                                target="_blank"
                                                rel="noopener noreferrer"
                                                className="inline-flex items-center text-blue-600 hover:text-blue-800 text-sm"
                                            >
                                                Open preview in new tab →
                                            </a>
                                        </div>
                                    </div>
                                    <button
                                        onClick={() => setPreviewUrl('')}
                                        className="w-full py-2 px-4 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50"
                                    >
                                        Create Another Card
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        function App() {
            return <UploadForm />;
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
